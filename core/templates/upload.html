<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Unit Tests</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #191919; /* ChatGPT Dark Background */
            color: #d1d5db; /* Light gray text */
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll */
            display: flex;
            height: 100vh;
            /* Animation for page load */
            opacity: 0; /* Start invisible */
            transition: opacity 0.6s ease-in-out; /* Transition over 0.8 seconds */
        }

        /* Style to apply after content is loaded to fade in */
        body.page-loaded {
            opacity: 1;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Poppins', monospace;
            line-height: 1.6;
            color: #d1d5db; /* Ensure preformatted text is readable */
            background-color: #2d2d37; /* Darker background for code blocks */
            padding: 1rem;
            border-radius: 0.25rem;
            overflow-x: auto; /* Add horizontal scroll for wide code */
             text-align: left; /* Ensure code stays left-aligned */
        }

        /* --- Common Styles from ChatGPT UI --- */
        .sidebar {
            width: 260px;
            height: 100vh;
            background-color: #202123; /* Darker sidebar background */
            position: fixed;
            top: 0;
            left: -260px;
            transition: left 0.3s ease;
            padding: 1rem; /* Reduced padding */
            z-index: 100;
            color: #d1d5db;
            box-sizing: border-box;
        }
        .sidebar.open {
            left: 0;
        }
        .sidebar-toggle {
            position: fixed;
            top: 13px;
            left: 1rem;
            cursor: pointer;
            z-index: 102; /* Higher z-index */
            color: #d1d5db;
            font-size: 1.5rem;
            transition: left 0.3s ease;
            line-height: 1;
            padding: 5px;
            background-color: transparent; /* Ensure transparent background */
            border: none;
             text-align: center; /* Toggle icon itself doesn't need alignment */
        }
         .sidebar.open ~ .sidebar-toggle {
             left: 270px;
         }

        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: #202123;
            z-index: 90;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #d1d5db;
            font-size: 1.1rem;
            font-weight: 600;
            transition: padding-left 0.3s ease, left 0.3s ease;
            box-sizing: border-box;
             text-align: center; /* Center text in top bar */
        }

        .top-bar-title {
            /* No specific alignment needed here, parent handles it */
        }

         .overlay {
             position: fixed;
             top: 0;
             left: 0;
             right: 0;
             bottom: 0;
             background-color: rgba(0, 0, 0, 0.5);
             z-index: 99;
             display: none;
         }
         .sidebar.open ~ .overlay {
             display: block;
         }

         .chatgpt-main-content {
             flex-grow: 1;
             display: flex;
             flex-direction: column;
             padding-top: 50px; /* Space for the fixed top bar */
             padding-bottom: 2rem;
             overflow-y: auto;
             -webkit-overflow-scrolling: touch;
             width: 100%;
             box-sizing: border-box;
         }

        .content-container {
            max-width: 768px;
            width: 100%;
            margin: 0 auto;
            padding: 1rem;
            box-sizing: border-box;
             text-align: center; /* Center most content within this container */
        }

        /* --- Page Specific Styles --- */
        .input-group {
            display: flex;
            align-items: center;
            margin-top: 1rem;
            gap: 0.5rem; /* Space between input and icon */
             /* Override center alignment for flex items */
             text-align: left;
        }
         .input-group label {
             flex-shrink: 0;
              text-align: left; /* Explicitly left align label */
         }

        .query-input {
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: #40414f;
            color: #d1d5db;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: border-color 0.3s ease, box-shadow 0.2s ease;
            width: 100%;
            box-sizing: border-box;
             text-align: left; /* Ensure user input text is left-aligned */
        }
        .query-input::placeholder {
             color: #8e8ea0;
             opacity: 0.7;
             /* Placeholder text alignment is usually left by default */
             text-align: left;
        }
        .query-input:focus {
            outline: none;
            border-color: #63b3ed;
            box-shadow: 0 0 5px rgba(99, 179, 237, 0.5);
        }

         /* Custom styling for file input */
         input[type="file"] {
             display: block;
             width: 100%;
             margin-top: 1rem;
             border: 1px solid rgba(255, 255, 255, 0.1);
             border-radius: 0.5rem;
             background-color: #40414f;
             color: #d1d5db;
             box-sizing: border-box;
             padding: 0.5rem;
              text-align: left; /* Ensure file input container is left-aligned */
         }

         input[type="file"]::file-selector-button {
             margin-right: 1rem;
             padding: 0.5rem 1rem;
             border-radius: 0.25rem;
             border: none;
             background-color: #50515f;
             color: #d1d5db;
             cursor: pointer;
             transition: background-color 0.2s ease;
             font-family: 'Poppins', sans-serif;
              text-align: center; /* File selector button text can be centered */
         }

         input[type="file"]::file-selector-button:hover {
             background-color: #60616f;
         }

         .or-divider {
             text-align: center;
             margin: 1.5rem 0;
             color: #8e8ea0;
             position: relative;
         }
         .or-divider::before,
         .or-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background-color: rgba(255, 255, 255, 0.1);
         }
         .or-divider::before { left: 0; }
         .or-divider::after { right: 0; }


        .submit-button {
            background-color: #50515f;
            color: #d1d5db;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
            cursor: pointer;
            font-weight: 500;
            border: none;
            display: block;
            width: 100%;
            margin-top: 2rem;
             text-align: center; /* Center button text */
        }
        .submit-button:hover:not(:disabled) {
            background-color: #60616f;
        }
         .submit-button:disabled {
             opacity: 0.5;
             cursor: not-allowed;
         }


        .response-area {
            background-color: #40414f;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-top: 2rem;
            word-break: break-word;
            display: none;
             text-align: left; /* Keep response area text left-aligned */
        }
        .response-area.visible {
             display: block;
        }
        .response-area h3 {
            text-align: left; /* Keep title left-aligned */
            margin-bottom: 1rem;
            color: #d1d5db;
            font-weight: 600;
            font-size: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.5rem;
        }

        .label-text {
            font-weight: 500;
            color: #d1d5db;
            margin-bottom: 1rem;
            text-align: center;
        }

        .eng-malayalam-style {
            font-family: 'Poppins', sans-serif;
            font-weight: 400;
            line-height: 1.6;
            letter-spacing: 0;
        }

        .sidebar h2 {
             color: #d1d5db;
             font-size: 1.2rem;
             margin-bottom: 0.5rem;
             padding-bottom: 0.5rem;
             border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .sidebar a {
            display: block;
            padding: 0.5rem 0.5rem;
            color: #d1d5db;
            text-decoration: none;
            transition: background-color 0.2s ease;
            border-radius: 0.25rem;
             text-align: left; /* Sidebar links are left-aligned */
        }
        .sidebar a:hover {
            background-color: #343541;
            color: #ececf1;
        }

        #loading {
            display: none;
            text-align: center; /* Center loading text */
            margin-top: 1rem;
            color: #8e8ea0;
            font-style: italic;
        }
        #downloadLink {
            display: none;
            margin-top: 1.5rem;
            text-align: center; /* Center download link */
        }
        #downloadLink a {
             color: #63b3ed;
             text-decoration: none;
             font-weight: 500;
             transition: color 0.2s ease;
        }
         #downloadLink a:hover {
             text-decoration: underline;
             color: #4299e1;
         }


        .info-icon {
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            color: #8e8ea0;
            transition: color 0.2s ease;
             /* Inherits text-align: left from .input-group */
        }
         .info-icon:hover {
             color: #d1d5db;
         }
         .info-icon svg {
             width: 1.25rem;
             height: 1.25rem;
             display: block;
         }
        .info-popup {
            visibility: hidden;
            width: 300px;
            background-color: #374151;
            color: #d1d5db;
            text-align: left; /* Keep popup text left-aligned */
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            white-space: normal;
            word-wrap: break-word;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
         .info-popup::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #374151 transparent transparent transparent;
         }

        .info-popup p {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
             text-align: left; /* Keep popup paragraphs left-aligned */
        }
         .info-popup p:last-child {
             margin-bottom: 0;
         }
         .info-popup code {
             background-color: rgba(255, 255, 255, 0.1);
             padding: 2px 4px;
             border-radius: 4px;
             font-size: 0.85rem;
         }
         /* Watermark Style */
         .watermark {
            position: fixed;
            bottom: 10px; /* Adjust as needed */
            right: 10px; /* Adjust as needed */
            color: rgba(142, 142, 160, 0.5); /* Semi-transparent grey, increased opacity slightly */
            font-size: 0.8rem; /* Adjust as needed */
            z-index: 51; /* Increased z-index to be above the input container */
            pointer-events: none; /* Ensure it doesn't interfere with clicks */
         }

    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Navigation</h2>
        <a href="/parayu.ai">Query</a>
        <a href="upload" class="bg-[#343541]">Unit Test</a>
        <a href="devtools">Dev Tools</a>
        <a href="intelligent-faq">Parayu iDEC</a>
    </div>

    <div class="sidebar-toggle" onclick="toggleSidebar()">☰</div>

    <div class="top-bar">
        <span class="top-bar-title">Parayu.ai</span>
    </div>

    <div class="overlay" onclick="toggleSidebar()"></div>


    <div class="chatgpt-main-content">
        <div class="content-container">
             <h1 class="text-2xl font-bold mb-6 mt-3" style="color: #d1d5db;">Generate Unit Tests</h1>
             <div class="mt-8" style="text-align: left;">
                <label for="repo" class="block text-sm font-medium mb-2" style="color: #d1d5db;">Upload Repository (ZIP File):</label>
                <input type="file" id="repo" name="repo" accept=".zip">
             </div>

            <div class="or-divider">OR</div>

            <div class="mt-4" style="text-align: left;">
                <label for="gitUrl" class="block text-sm font-medium mb-2" style="color: #d1d5db;">Enter Git Repository URL:</label>
                 <div class="input-group">
                    <input type="text" id="gitUrl" placeholder="e.g., https://github.com/user/repo.git" class="query-input">
                    <div class="info-icon" id="infoIcon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.3-.06a1.5 1.5 0 012.69 0l.3.06a1.5 1.5 0 01-2.69 0zM16.5 12a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 12a6.75 6.75 0 10-13.5 0 6.75 6.75 0 0113.5 0z" />
                        </svg>
                        <div class="info-popup" id="infoPopup">
                            <p><strong>Git Repository URL Format:</strong></p>
                            <p><strong>Public Repo:</strong> <code>https://github.com/user/repo.git</code></p>
                            <p><strong>PAT Repo (e.g., Azure DevOps):</strong></p>
                             <p><code>https://&lt;username&gt;:&lt;pat&gt;@dev.azure.com/&lt;org&gt;/&lt;proj&gt;/_git/&lt;repo&gt;</code></p>
                            <p class="mt-2 text-xs italic">Replace placeholders with your actual values.</p>
                        </div>
                    </div>
                 </div>
            </div>


            <button onclick="uploadRepo()" class="submit-button">Upload / Generate Unit Tests</button>

            <div id="loading">Processing...</div>
            <div id="downloadLink"></div>

            <div id="testsArea" class="response-area mt-8">
                 <h3 class="eng-malayalam-style">Generated Unit Tests:</h3>
                 <pre id="tests" class="mt-4 eng-malayalam-style"></pre>
             </div>
        </div>
    </div>

    <div class="watermark">
        Powered by Titans
    </div>

    <script>
        // Function to add the 'page-loaded' class to trigger fade-in
        function fadeInPage() {
            document.body.classList.add('page-loaded');
        }

        // Call fadeInPage when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', fadeInPage);


        document.addEventListener('DOMContentLoaded', function() {
            const infoIcon = document.getElementById('infoIcon');
            const infoPopup = document.getElementById('infoPopup');
            const gitUrlInput = document.getElementById('gitUrl');
            const fileInput = document.getElementById('repo');
            const submitButton = document.querySelector('.submit-button');

            // Function to update button disabled state
            function updateButtonState() {
                const fileSelected = fileInput.files.length > 0;
                const urlEntered = gitUrlInput.value.trim() !== '';
                submitButton.disabled = !(fileSelected || urlEntered);
                submitButton.style.cursor = submitButton.disabled ? 'not-allowed' : 'pointer';
            }

            // Add event listeners to update button state
            fileInput.addEventListener('change', updateButtonState);
            gitUrlInput.addEventListener('input', updateButtonState);

            // Initial state check
            updateButtonState();


            infoIcon.addEventListener('mouseover', function() {
                infoPopup.style.visibility = 'visible';
                infoPopup.style.opacity = '1';

                 // Simple check to keep popup on screen
                 const rect = infoPopup.getBoundingClientRect();
                 const viewportHeight = window.innerHeight;

                 if (rect.bottom > viewportHeight && rect.top > infoIcon.getBoundingClientRect().top) {
                     // If popup is below viewport and icon is above, position above icon
                     infoPopup.style.bottom = '125%';
                     infoPopup.style.top = 'auto';
                 } else if (rect.top < 0 && rect.bottom < infoIcon.getBoundingClientRect().bottom) {
                     // If popup is above viewport and icon is below, position below icon
                      infoPopup.style.top = '100%';
                      infoPopup.style.bottom = 'auto';
                 } else {
                     /* Default: Position above icon */
                     infoPopup.style.bottom = '125%';
                     infoPopup.style.top = 'auto';
                 }
            });

            infoIcon.addEventListener('mouseout', function() {
                infoPopup.style.visibility = 'hidden';
                infoPopup.style.opacity = '0';
            });
        });


        function uploadRepo() {
            const loading = document.getElementById('loading');
            const tests = document.getElementById('tests');
            const downloadLinkDiv = document.getElementById('downloadLink');
            const fileInput = document.getElementById("repo");
            const gitUrlInput = document.getElementById('gitUrl');
            const submitButton = document.querySelector('.submit-button');
            const testsArea = document.getElementById('testsArea');


            downloadLinkDiv.innerHTML = '';
            downloadLinkDiv.style.display = 'none';
            tests.innerText = '';
            testsArea.style.display = 'none';


            const file = fileInput.files[0];
            const gitUrl = gitUrlInput.value.trim();

            if (!file && !gitUrl) {
                 // Button should be disabled, so this ideally isn't reached
                 alert("Please select a file or enter a Git URL.");
                 return;
            }

            // Disable input and button
            fileInput.disabled = true;
            gitUrlInput.disabled = true;
            submitButton.disabled = true;
            submitButton.style.cursor = 'not-allowed';


            loading.style.display = 'block';
             loading.innerText = 'Processing...';


            console.log("uploadRepo() called");

            const formData = new FormData();

            if (file) {
                formData.append("repo", file);
                 loading.innerText = 'Uploading file and processing...';
            }
            if (gitUrl) {
                formData.append('gitUrl', gitUrl);
                 loading.innerText = 'Cloning repository and processing...';
            }

            fetch("/api/upload-repo/", {
                method: "POST",
                body: formData,
            })
            .then(response => {
                 if (!response.ok) {
                    return response.json().catch(() => {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    });
                 }
                return response.json();
            })
            .then(data => {
                console.log("Response Data:", data);

                loading.style.display = 'none';

                if (data.error) {
                     testsArea.style.display = 'block';
                     tests.style.color = '#f08080';
                     tests.innerText = 'Error: ' + data.error;
                     if (data.details) {
                         tests.innerText += '\nDetails: ' + data.details;
                     }
                } else {
                    let formattedTests = '';
                    if (data.unit_tests && Object.keys(data.unit_tests).length > 0) {
                         for (const filename in data.unit_tests) {
                             // Wrap code in markdown code block
                             formattedTests += `### ${filename}\n\`\`\`python\n${data.unit_tests[filename]}\n\`\`\`\n\n`;
                         }
                          testsArea.style.display = 'block';
                          tests.style.color = '#d1d5db';
                         tests.innerText = formattedTests;
                    } else {
                         testsArea.style.display = 'block';
                         tests.style.color = '#8e8ea0';
                         tests.innerText = 'No unit tests were generated for the provided input.';
                    }


                    if (data.zip_content) {
                        try {
                            const byteCharacters = atob(data.zip_content);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            const byteArray = new Uint8Array(byteNumbers);

                            const blob = new Blob([byteArray], { type: 'application/zip' });
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'unit_tests.zip';
                            a.textContent = 'Download Generated Tests (ZIP)';
                            downloadLinkDiv.appendChild(a);
                            downloadLinkDiv.style.display = 'block';

                            a.addEventListener('click', () => {
                                setTimeout(() => { window.URL.revokeObjectURL(url); }, 1000);
                            });
                            window.addEventListener('beforeunload', () => {
                                window.URL.revokeObjectURL(url);
                            });

                        } catch (error) {
                            console.error("Decoding or Blob Error:", error);
                             testsArea.style.display = 'block';
                             tests.style.color = '#f08080';
                            tests.innerText = (tests.innerText ? tests.innerText + '\n' : '') + 'Error processing zip file for download.';
                        }
                    }
                }


            })
            .catch(error => {
                console.error("Fetch Error:", error);
                 loading.style.display = 'none';
                 testsArea.style.display = 'block';
                 tests.style.color = '#f08080';
                tests.innerText = 'An error occurred during the upload and processing. Please check the browser console for details.';
            })
            .finally(() => {
                fileInput.disabled = false;
                gitUrlInput.disabled = false;
                submitButton.disabled = false;
                submitButton.style.cursor = 'pointer';
                 fileInput.value = '';
                 gitUrlInput.value = '';
                 updateButtonState();
            });
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('open');
        }

         document.querySelector('.overlay').addEventListener('click', toggleSidebar);
    </script>
</body>
</html>